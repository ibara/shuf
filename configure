#!/bin/sh

# This configure script written by Brian Callahan <bcallah@openbsd.org>
# and released into the Public Domain.

cccheck() {
  if [ ! -z "$CC" ] ; then
cat << EOF > conftest.c
int main(void){return 0;}
EOF
    $CC $cflags $ldflags -o conftest conftest.c > /dev/null 2>&1
    if [ $? -eq 0 ] ; then
      ./conftest
      if [ $? -eq 0 ] ; then
	rm -f conftest conftest.o conftest.c
	cc="$CC"
	return 0
      else
	echo "could not build working executables"
	echo "Please ensure your C compiler is a native compiler"
	exit 1
      fi
    else
      rm -f conftest conftest.o conftest.c
    fi
  fi

  for compiler in cc clang pcc xlc gcc ; do
cat << EOF > conftest.c
int main(void){return 0;}
EOF

    $compiler $cflags $ldflags -o conftest conftest.c > /dev/null 2>&1

    if [ $? -eq 0 ] ; then
      ./conftest
      if [ $? -eq 0 ] ; then
	rm -f conftest conftest.o conftest.c
	cc="$compiler"
	return 0
      else
	echo "could not build working executables"
	echo "Please ensure your C compiler is a native compiler"
	exit 1
      fi
    else
      rm -f conftest conftest.o conftest.c
    fi
  done
  return 1
}

arc4randomuniformcheck() {
  cat << EOF > conftest.c
#include <stdlib.h>
int main(void){arc4random_uniform(0);return 0;}
EOF
  "$cc" $cflags $ldflags -o conftest conftest.c > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest conftest.o conftest.c
    return 0
  else
    rm -f conftest conftest.o conftest.c
    return 1
  fi
}

deadcheck() {
  cat << EOF > conftest.c
#include <stdlib.h>
__dead usage(void){exit(1);}int main(void){usage();return 0;}
EOF
  $cc $cflags $ldflags -o conftest conftest.c > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest conftest.o conftest.c
    return 0
  else
    rm -f conftest conftest.o conftest.c
    return 1
  fi
}

dead2check() {
  cat << EOF > conftest.c
#include <stdlib.h>
__dead2 usage(void){exit(1);}int main(void){usage();return 0;}
EOF
  $cc $cflags $ldflags -o conftest conftest.c > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest conftest.o conftest.c
    return 0
  else
    rm -f conftest conftest.o conftest.c
    return 1
  fi
}

getprognamecheck() {
  cat << EOF > conftest.c
#include <stdlib.h>
int main(void){getprogname();return 0;}
EOF
  "$cc" $cflags $ldflags -o conftest conftest.c > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest conftest.o conftest.c
    return 0
  else
    rm -f conftest conftest.o conftest.c
    return 1
  fi
}

libbsdcheck() {
  cat << EOF > conftest.c
#include <bsd/stdlib.h>
int main(void){strtonum(NULL, 0, 0, NULL);return 0;}
EOF
  "$cc" $cflags $ldflags -o conftest conftest.c -lbsd > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest conftest.o conftest.c
    return 0
  else
    rm -f conftest conftest.o conftest.c
    return 1
  fi
}

noreturncheck() {
  cat << EOF > conftest.c
#include <stdlib.h>
__attribute__((__no_return__)) usage(void){exit(1);}int main(void){usage();return 0;}
EOF
  $cc $cflags $ldflags -o conftest conftest.c > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest conftest.o conftest.c
    return 0
  else
    rm -f conftest conftest.o conftest.c
    return 1
  fi
}

pledgecheck() {
  cat << EOF > conftest.c
#include <unistd.h>
int main(void){pledge(NULL,NULL);return 0;}
EOF
  $cc $cflags $ldflags -o conftest conftest.c > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest conftest.o conftest.c
    return 0
  else
    rm -f conftest conftest.o conftest.c
    return 1
  fi
}

reallocarraycheck() {
  cat << EOF > conftest.c
#include <stdlib.h>
int main(void){reallocarray(NULL, 0, 0);return 0;}
EOF
  $cc $cflags $ldflags -o conftest conftest.c > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest conftest.o conftest.c
    return 0
  else
    rm -f conftest conftest.o conftest.c
    return 1
  fi
}

strtonumcheck() {
  cat << EOF > conftest.c
#include <stdlib.h>
int main(void){strtonum(NULL, 0, 0, NULL);return 0;}
EOF
  "$cc" $cflags $ldflags -o conftest conftest.c > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest conftest.o conftest.c
    return 0
  else
    rm -f conftest conftest.o conftest.c
    return 1
  fi
}

prefix="/usr/local"
libs=""
libbsd=0

if [ ! -z "$CFLAGS" ] ; then
  cflags="$CFLAGS"
else
  cflags=""
fi

if [ ! -z "$CPPFLAGS" ] ; then
  cflags="$cflags $CPPFLAGS"
fi

if [ ! -z "$LDFLAGS" ] ; then
  ldflags="$LDFLAGS"
else
  ldflags=""
fi

printf "checking for C compiler... "
cccheck
if [ $? -eq 0 ] ; then
  echo "$cc"
else
  echo "not found"
  echo "Please install a C compiler and re-run configure."
  exit 1
fi

printf "checking for OS... "
os=`uname -s`
echo "$os"

if [ "x$os" = "xNetBSD" ] ; then
  cflags="$cflags -D_OPENBSD_SOURCE"
fi

printf "checking for __dead... "
deadcheck
if [ $? -eq 0 ] ; then
  echo "yes"
else
  echo "no"
  printf "checking for __dead2... "
  dead2check
  if [ $? -eq 0 ] ; then
    cflags="$cflags -D__dead=__dead2"
    echo "yes"
  else
    echo "no"
    printf "checking for __attribute__((__no_return__))... "
    noreturncheck
    if [ $? -eq 0 ] ; then
      cflags="$cflags -D__dead=\"__attribute__((__no_return__))\""
      echo "yes"
    else
      cflags="$cflags -D__dead="
      echo "no"
    fi
  fi
fi

printf "checking for arc4random_uniform... "
arc4randomuniformcheck
if [ $? -eq 0 ] ; then
  echo "yes"
else
  libbsd=1
  echo "no"
fi

printf "checking for getprogname... "
getprognamecheck
if [ $? -eq 0 ] ; then
  echo "yes"
else
  libbsd=1
  echo "no"
fi

printf "checking for pledge... "
pledgecheck
if [ $? -eq 0 ] ; then
  cflags="$cflags -DHAVE_PLEDGE"
  echo "yes"
else
  echo "no"
fi

printf "checking for reallocarray... "
reallocarraycheck
if [ $? -eq 0 ] ; then
  echo "yes"
else
  libbsd=1
  echo "no"
fi

printf "checking for strtonum... "
strtonumcheck
if [ $? -eq 0 ] ; then
  echo "yes"
else
  libbsd=1
  echo "no"
fi

if [ $libbsd -eq 1 ] ; then
  printf "checking for libbsd... "
  libbsdcheck
  if [ $? -ne 0 ] ; then
    echo "not found"
    echo "You need libbsd to build shuf!"
    exit 1
  fi
  cflags="$cflags -DLIBBSD"
  libs=" -lbsd"
  echo "yes"
fi

printf "creating Makefile... "
cat << EOF > Makefile
# This Makefile automatically generated by configure.

CC =		$cc
EOF

if [ ! -z "$cflags" ] ; then
  cat << EOF >> Makefile
CFLAGS =	$cflags
EOF
fi

if [ ! -z "$ldflags" ] ; then
  cat << EOF >> Makefile
LDFLAGS =	$ldflags
EOF
fi

cat << EOF >> Makefile

PREFIX ?=	/usr/local
MANDIR ?=	\${PREFIX}/man

PROG =	shuf
OBJS =	shuf.o

all: \${OBJS}
	\${CC} \${LDFLAGS} -o \${PROG} \${OBJS} $libs

install:
	install -c -S -s -m 755 \${PROG} \${PREFIX}/bin
	install -c -S -m 644 shuf.1 \${MANDIR}/man1/\${PROG}.1

test:
	@echo ====================================
	@echo BSD shuf test suite
	@echo ====================================
	@echo Test 1: File input
	@echo shuf shuf.c
	@./shuf shuf.c || (echo Test 1 failed; exit 1)
	@echo ====================================
	@echo Test 2: -e flag, -n flag, -r flag
	@echo shuf -e -n 10 -r Heads Tails
	@./shuf -e -n 10 -r Heads Tails || (echo Test 2 failed; exit 1)
	@echo ====================================
	@echo Test 3: -i flag
	@echo shuf -i 1-20 -n 10
	@./shuf -i 1-20 -n 10 || (echo Test 3 failed; exit 1)
	@echo ====================================
	@echo All tests passed
	@echo ====================================

clean:
	rm -f \${PROG} \${OBJS} \${PROG}.core

distclean: clean
	rm -f Makefile
EOF
echo "done"
